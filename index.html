<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-OS-Challenge-SWAP" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/25/OS-Challenge-SWAP/" class="article-date">
  <time class="dt-published" datetime="2025-06-25T14:24:48.000Z" itemprop="datePublished">2025-06-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/06/25/OS-Challenge-SWAP/">OS-Challenge-SWAP</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次代码增量在 400 行左右，和隔壁 SHELL 挑战性任务相比简直是小巫见大巫，不过我认识的倒是有几个从 SWAP 转战 SHELL 的。SWAP 挑战任务重要的是对内存管理的理解和原有代码逻辑的理解，我也是因为以为自己对这部分内容足够熟悉才选择了这个题目。写完这个题目我才对原有的内存管理有了更深的理解。</p>
<p>从 6 月 3 日选定这个题目、开始设计框架、在讨论区问了一系列问题，到 6 月 9 日真正开始写代码，遇到许多现象奇特的 bug、经历了重构和面对奇异现象束手无策，没日没夜在宿舍写了 7 天才过了评测。也不知道现在这个实现还有没有 bug（</p>
<p>这个任务其实描述起来并不难，码量也不多，不过就是在管理内存的时候多了一块磁盘可以换出罢了。但是实现起来细节很多，稍微不慎从现象找问题就很困难。</p>
<h2 id="任务分解"><a href="#任务分解" class="headerlink" title="任务分解"></a>任务分解</h2><ul>
<li>读写磁盘</li>
<li>换出页面时选择页面、管理页表和 TLB</li>
<li>换入页面时找到对应的磁盘块、管理页表和 TLB</li>
</ul>
<p>是的，把要做的任务一一列出来就这么一点，下面我们来分步处理。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h3 id="读写磁盘"><a href="#读写磁盘" class="headerlink" title="读写磁盘"></a>读写磁盘</h3><p>我们读写 SWAP 磁盘只会在内核态进行，所以想起什么来了吗？</p>
<p>是的，指导书中曾经给出了在内核态读写磁盘的代码，不过我们当时的文件服务函数是在用户态实现的，需要依据其改写。对于本次挑战性任务来说就是得来全不费工夫。</p>
<p>不过为了避免与文件系统使用的主 IDE 控制器冲突，我们可以在内核态使用从 IDE 控制器读写磁盘，用于存储交换页面。需要额外定义<code>#define MALTA_IDE_BASE2 (MALTA_PCIIO_BASE + 0x0170)</code>以及依赖 <code>MALTA_IDE_BASE</code> 而定义的宏就 OK 了。</p>
<p>这个功能其实是相对独立的，写完之后就可以自己测试一下看看有没有问题。</p>
<p>并且在读取磁盘时是按页读取，这个函数是按扇区读取，可以小小封装一下方便使用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">read_disk_block</span><span class="params">(<span class="type">int</span> diskno, <span class="type">int</span> block_num, <span class="type">void</span>* dst)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">write_disk_block</span><span class="params">(<span class="type">int</span> diskno, <span class="type">int</span> block_num, <span class="type">void</span>* src)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><h4 id="维护换出物理页向磁盘块的单向映射关系"><a href="#维护换出物理页向磁盘块的单向映射关系" class="headerlink" title="维护换出物理页向磁盘块的单向映射关系"></a>维护换出物理页向磁盘块的单向映射关系</h4><p>当 swap out 时，将对应磁盘块编号代替该换出页对应的所有页表项中的物理页号部分，并选用了页表项中的保留软标志位标志其换出。在访问查询页表时若有该标志位，则依据磁盘号将该页表换出即可。</p>
<h4 id="维护磁盘的使用情况和换出页状态"><a href="#维护磁盘的使用情况和换出页状态" class="headerlink" title="维护磁盘的使用情况和换出页状态"></a>维护磁盘的使用情况和换出页状态</h4><p>可以像管理物理内存一样，在内核开辟<code>Page</code>结构体，若换出则将换出页的数据复制到这个象征磁盘空间的数据结构中来保存页面的状态，并和管理空闲页面一样使用链表进行空闲磁盘块的管理。</p>
<p>这里复用了<code>Page</code>结构体，如果要更节省一点空间，可以只保留<code>pp_ref``pte_list</code>这两个成员另开一个结构体。</p>
<h4 id="维护映射该页面的页表项"><a href="#维护映射该页面的页表项" class="headerlink" title="维护映射该页面的页表项"></a>维护映射该页面的页表项</h4><p>由于映射到物理页面的虚拟地址个数不确定，这就需要使用链表管理。在节点中存储页表项地址以便在换出之时能够更改页表项，来表示换出和存储相应磁盘块地址。</p>
<p>该节点的结构体定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pte_refed</span> &#123;</span></span><br><span class="line">    LIST_ENTRY(Pte_refed) pte_link;</span><br><span class="line">    Pte *pte;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个节点需要在内核空间中预先开辟空间，一个问题就来了，开多少个呢？预留给内核的空间大小是 4 MB，但是这个节点只要映射在同一物理地址的虚拟页面足够多，在物理空间够的情况下也会出问题。这时候就要现在内核空间允许的范围内尽量多开一些，然后在节点用尽的时候<code>panic</code>一下，如果报错的话十分方便定位问题。</p>
<p>ps:这是一个十分好的定位 bug 的方法，只要在一些地方写上正常情况不可能发生的<code>panic</code>方便定位问题。</p>
<p>ps:如果开的过大超过了内核空间，会在开始的时候就卡死。</p>
<h4 id="管理页面"><a href="#管理页面" class="headerlink" title="管理页面"></a>管理页面</h4><p>最后，我的<code>Page</code>结构体如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Page</span> &#123;</span></span><br><span class="line">    Page_LIST_entry_t pp_link; <span class="comment">/* free list link */</span></span><br><span class="line">    TAILQ_ENTRY(Page) pp_tail;</span><br><span class="line">    u_short pp_ref;</span><br><span class="line">    u_short PG_referenced;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pte_list</span> <span class="title">pte_list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>新增的<code>pp_tail</code>用来维护 TAILQ 链表来实现替换页面的选择，<code>PG_referenced</code>是访问的标志位，<code>pte_list</code>是管理映射到该页面虚拟地址的头节点。</p>
<h3 id="刷新-TLB，监测页面访问与页面替换算法"><a href="#刷新-TLB，监测页面访问与页面替换算法" class="headerlink" title="刷新 TLB，监测页面访问与页面替换算法"></a>刷新 TLB，监测页面访问与页面替换算法</h3><p>将 TLB 全部填零的函数助教已在讨论区给出，只要在每次<code>schedule</code>的时候调用就行。由于 MIPS 的奇偶页设计，在重填时就默认同时访问了两个页面。</p>
<p>至于页面替换算法，指导书中已经描述的很详细了，就是维护可换出页面的链表（可换出页面参见下文）。这部分主要是 C 语言编程的问题，就不在此赘述了。</p>
<h3 id="页面的换出"><a href="#页面的换出" class="headerlink" title="页面的换出"></a>页面的换出</h3><p>解决了前面相对独立且基础的功能，重头戏就要来了。</p>
<h4 id="什么页面能换出"><a href="#什么页面能换出" class="headerlink" title="什么页面能换出"></a>什么页面能换出</h4><p>若是换出了会在内核态直接访问而不经过 TLB 的地址，直接访问会导致地址错误。那么什么页面是会在内核态直接访问的呢？</p>
<p>就是在 kseg0 中的地址，抹掉高位直接访问了。这种页面在申请时有个特点，就是调用<code>page_alloc</code>函数后直接<code>page_ref++</code>而不调用<code>page_insert</code>。这类页面包括每个进程的一级页目录，为内核保留的空间和pages占的空间。</p>
<p>但是排除法恐有疏漏，我们可以直接正面统计能够换出的页面。在用户态申请的页面自然可以换出，而用户态通过<code>sys_mem_alloc</code>系统调用申请页面。在不影响内核页面管理的前提下，不动<code>page_insert</code>函数，只是复制并增加将新申请的页面加入链表的步骤，命名为<code>page_insert_user_alloc</code>供系统调用调用。</p>
<h4 id="如何换出"><a href="#如何换出" class="headerlink" title="如何换出"></a>如何换出</h4><p>在 <code>page_alloc</code> 中，如果页面空闲链表为空，就</p>
<ul>
<li>依据页面替换策略选择换出页面</li>
<li>在磁盘空闲链表中选择一个空闲块</li>
<li>遍历引用该页面的页表项，修改物理页地址为块地址，将有效位置零，换出位置一</li>
<li>将页面控制块内容复制到磁盘控制块中<ul>
<li>这里需要额外注意<code>pp-&gt;pte_list.lh_first-&gt;pte_link.le_prev = &amp;disk_block-&gt;pte_list.lh_first;</code>要将第一个节点往回指向链表头的指针从指向页面中的链表头改为指向磁盘控制块的链表头</li>
</ul>
</li>
<li>将页面内容写入磁盘</li>
<li>将页面初始化</li>
<li><code>flush_all_tlb</code></li>
</ul>
<h3 id="页面的换入"><a href="#页面的换入" class="headerlink" title="页面的换入"></a>页面的换入</h3><h4 id="何时换入"><a href="#何时换入" class="headerlink" title="何时换入"></a>何时换入</h4><p>当用户访问时会经过 TLB 进行页表项的重填，是使用<code>page_lookup</code>来找到的相关页面。</p>
<p>当取消映射时，也是使用<code>page_lookup</code>来找到相应页表项。</p>
<p>当新增映射<code>page_insert</code>，还是使用<code>page_lookup</code>来找到虚拟地址原有映射。</p>
<p>在<code>page_lookup</code>中添加换入逻辑是再合适不过的。</p>
<h4 id="如何换入"><a href="#如何换入" class="headerlink" title="如何换入"></a>如何换入</h4><p>在查到页表项的换出标志位是 1 的时候，换入就开始了。</p>
<ul>
<li>使用<code>page_alloc</code>分配一个页面</li>
<li>依据页表内容得到磁盘块号</li>
<li>将磁盘内容读入到刚分配的页面</li>
<li>将磁盘控制块的内容复制到页面控制块中，同样注意<code>pp-&gt;pte_list.lh_first-&gt;pte_link.le_prev = &amp;pp-&gt;pte_list.lh_first;</code>更改第一个节点往回指的指针</li>
<li>遍历引用该页面的页表项，修改块地址为物理页地址，将有效位置一，换出位置零</li>
<li>将该页面加入可换出的页表（肯定是能被换出才有现在的换入，当然能再次换出了）</li>
</ul>
<h3 id="fork-与写时复制的处理"><a href="#fork-与写时复制的处理" class="headerlink" title="fork 与写时复制的处理"></a>fork 与写时复制的处理</h3><p>只要按照上面的思路，这就不是什么特殊的事情，只需要<code>fork</code>时让换出位有效的也进入<code>duppage</code>，在<code>page_lookup</code>的时候页面自然会被调入。</p>
<p>至于写时复制，一个要注意的点就是要即时更新 TLB，不然会进入两次 <code>cow_entry</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/25/OS-Challenge-SWAP/" data-id="cmcc1xgk50000vsfbd1ds2ssk" data-title="OS-Challenge-SWAP" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OS/" rel="tag">OS</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/25/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-06-25T14:13:32.723Z" itemprop="datePublished">2025-06-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/06/25/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/25/hello-world/" data-id="cmcc1xgk70001vsfb9yi6ewol" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/OS/" rel="tag">OS</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/OS/" style="font-size: 10px;">OS</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/25/OS-Challenge-SWAP/">OS-Challenge-SWAP</a>
          </li>
        
          <li>
            <a href="/2025/06/25/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>